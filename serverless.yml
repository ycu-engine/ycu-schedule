service: ycu-schedule

provider:
  name: aws
  runtime: nodejs14.x
  region: ${opt:region, self:custom.variables.region}
  stage: ${opt:stage, self:custom.variables.stage}
  # environment:
  #   COGNITO_DOMAIN: ${env:COGNITO_DOMAIN}
  #   COGNITO_CLIENT_ID: ${self:custom.cognito.clientId.${self:provider.stage}}
  #   COGNITO_USER_POOL_ID: ${self:custom.cognito.userPoolId.${self:provider.stage}}

custom:
  variables:
    region: ${env:AWS_REGION, ap-northeast-1}
    stage: ${env:AWS_STAGE, 'dev'}
    tableName: ${self:service}-${self:custom.variables.stage}
  dynamodb:
    stages:
      - dev
    start:
      port: 8000
      inMemory: true
      heapInitial: 200m
      heapMax: 1g
      migrate: true
      seed: true
      convertEmptyValues: true
    seed:
      sample:
        sources:
          - table: ${self:custom.variables.tableName}
            sources:
              - ./seed/sample-user.json
              - ./seed/sample-news.json
              - ./seed/sample-course.json
  capacities:
    - tableName: ${self:custom.variables.tableName}
      index:
        - byCreatedAt
        - byWeekByPeriodByCode
        - byCodeByWeekByPeriod
      read:
        minimum: 5 # Minimum read capacity
        maximum: 1000 # Maximum read capacity
        usage: 0.75 # Targeted usage percentage
      write:
        minimum: 40 # Minimum write capacity
        maximum: 200 # Maximum write capacity
        usage: 0.5 # Targeted usage percentage

resources:
  Resources:
    YcuSchedule:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.variables.tableName}
        AttributeDefinitions:
          - AttributeName: typeName
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: N
          - AttributeName: weekPeriodCode
            AttributeType: S
          - AttributeName: codeWeekPeriod
            AttributeType: S
        KeySchema:
          - AttributeName: typeName
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 5
          WriteCapacityUnits: 5
        LocalSecondaryIndexes:
          - IndexName: byCreatedAt
            KeySchema:
              - AttributeName: typeName
                KeyType: HASH
              - AttributeName: createdAt
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY
          - IndexName: byWeekByPeriodByCode
            KeySchema:
              - AttributeName: typeName
                KeyType: HASH
              - AttributeName: weekPeriodCode
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY
          - IndexName: byCodeByWeekByPeriod
            KeySchema:
              - AttributeName: typeName
                KeyType: HASH
              - AttributeName: codeWeekPeriod
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY

plugins:
  - serverless-dynamodb-local
  - serverless-dynamodb-autoscaling
